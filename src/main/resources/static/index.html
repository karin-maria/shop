<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Item</title>
    <script>

        document.addEventListener('DOMContentLoaded', function() {
            fetchItems();
            fetchShoppingLists();
        });

        // ********************* CATEGORIES ********************************
        function submitCategoryForm(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const jsonData = Object.fromEntries(formData.entries());

            fetch('/api/categories/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(jsonData),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                event.target.reset(); // Reset form after submission
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to add the category.');
            });
        }

        // ************************** ITEMS *******************************

        function submitItemForm(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const jsonData = {};
            formData.forEach((value, key) => {
                jsonData[key] = key === 'categoryId' ? parseInt(value, 10) : value;
            });

            fetch('/api/items/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(jsonData),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // ******************** SHOPPING LISTS *************************

        let shoppingListItems = [];

        function fetchItems() {
            fetch('/api/items/all')
                .then(response => response.json())
                .then(data => {
                    const itemSelect = document.getElementById('itemSelect');
                    data.forEach(item => {
                        let option = new Option(item.name, item.id);
                        itemSelect.add(option);
                    });
                })
                .catch(error => console.error('Error fetching items:', error));
        }

        function addItemToList() {
            const itemSelect = document.getElementById('itemSelect');
            const quantityInput = document.getElementById('quantity');
            const itemName = itemSelect.options[itemSelect.selectedIndex].text;
            const itemId = itemSelect.value;
            const quantity = quantityInput.value;

            if (!itemId || quantity <= 0) {
                alert('Please select an item and enter a positive quantity.');
                return;
            }

            shoppingListItems.push({
                itemId,
                quantity
            });

            const itemList = document.getElementById('itemList');
            itemList.innerHTML += `<li>${itemName} - Quantity: ${quantity}</li>`;

            itemSelect.selectedIndex = 0;
            quantityInput.value = '';
        }

        function createShoppingList(event) {
            event.preventDefault();
            const listNameInput = document.getElementById('listName');
            const listName = listNameInput.value;

            if (!listName.trim() || shoppingListItems.length === 0) {
                alert('Please enter a list name and add at least one item.');
                return;
            }

            fetch('/api/shoppingLists/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: listName,
                    items: shoppingListItems
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                // Reset UI
                listNameInput.value = '';
                document.getElementById('itemList').innerHTML = '';
                shoppingListItems = []; // Clear the in-memory list
            })
            .catch(error => {
                console.error('Error:', error);
                console.log(response)
                console.log(response.body)
                alert('Failed to create the shopping list.');
            });
        }

        // VIEW

        function fetchShoppingLists() {
            fetch('/api/shoppingLists/all')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('shoppingListsSelect');
                    data.forEach(list => {
                        let option = new Option(list.name, list.id);
                        select.add(option);
                    });
                })
                .catch(error => console.error('Failed to load shopping lists:', error));
        }

        function fetchAndDisplayShoppingList() {
            const id = document.getElementById('shoppingListsSelect').value;
            fetch(`/api/shoppingLists/${id}`)
                .then(response => response.json())
                .then(data => {
                    const detailsDiv = document.getElementById('shoppingListDetails');
                    detailsDiv.innerHTML = `<h3>${data.name}</h3>`;
                    data.items.forEach(item => {
                        detailsDiv.innerHTML += `<p>${item.item.name} - Quantity: ${item.quantity}</p>`;
                    });
                })
                .catch(error => console.error('Failed to load shopping list details:', error));
        }
    </script>
</head>


<body>

    <h2>Add New Category</h2>
    <form id="addCategoryForm" onsubmit="submitCategoryForm(event)">
        <input type="text" name="name" placeholder="Category Name" required>
        <button type="submit">Add Category</button>
    </form>

    <h2>Add New Item</h2>
    <form id="addItemForm" onsubmit="submitItemForm(event)">
        <input type="text" name="name" placeholder="Item Name" required>
        <input type="number" name="categoryId" placeholder="Category ID" required>
        <button type="submit">Add Item</button>
    </form>

    <h2>Create New Shopping List</h2>
    <div>
        <input type="text" id="listName" placeholder="Shopping List Name" required>
        <select id="itemSelect">
            <!-- Items will be populated here -->
        </select>
        <input type="number" id="quantity" placeholder="Quantity" min="1" required>
        <button onclick="addItemToList()">Add Item to List</button>
    </div>
    <ul id="itemList">
        <!-- Added items will be listed here -->
    </ul>
    <button onclick="createShoppingList(event)">Create Shopping List</button>

    <h2>Select a Shopping List</h2>
    <select id="shoppingListsSelect" onchange="fetchAndDisplayShoppingList()">
        <option value="">Please select a shopping list</option>
        <!-- Shopping lists will be populated here -->
    </select>
    <div id="shoppingListDetails">
        <!-- Shopping list details will be displayed here -->
    </div>
</body>
</html>